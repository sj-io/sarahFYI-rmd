---
title: "Mario Kart Speedruns"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    navbar:
      - { icon: "fas fa-home", href: "index.html", align: right}
    theme:
      version: 4
      bootswatch: minty
runtime: shiny
---

```{bash llstocsv, include=FALSE}
# Convert all lss files in folder to csv
MK8D_trk2csv ./_data/splits ./_data/splits MK8D_trks.csv
```

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(plotly)
```

```{r getData, include=FALSE}
source("lsstocsv.R")

sr %>% count(cat1)
```

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
selectInput("v_cat2", label = "Select a Category:", choices = ct2)
```


Column {data-width=350}
-----------------------------------------------------------------------

### Track Time Distribution

```{r}
renderPlotly({
  ggViolin <- stdev %>%
    filter(cat2 == input$v_cat2) %>%
    ggplot(aes(factor(track), time)) +
    geom_violin(scale = "width",
                aes(fill = sd, color = sd),
                alpha = .7) +
    stat_summary(fun = "mean",
                 geom = "crossbar",
                 size = .2,
                 aes(color = sd)) +
    stat_summary(fun = "median", geom = "point", size = .4) +
    scale_y_time() +
    scale_x_discrete(limits = rev) +
    coord_flip() +
    labs(x = "",
         y = "Time") +
    theme_minimal() +
    theme(
      axis.text.x = element_text(
        angle = 45,
        hjust = 0.98,
        vjust = 0.9
      ),
      axis.text = element_text(size = 8),
      axis.ticks = element_line(size = .2),
      panel.grid = element_line(size = .2),
      panel.border = element_rect(fill = NA, size = .2),
      legend.position = "none"
    )
  
    ggplotly(ggViolin)
})
```

Column
-----------------------------------------------------------------------

### Improvement

```{r warning=FALSE}
renderPlotly({
  rn <- runs %>% filter(cat2 == input$v_cat2)
  
  colors <- color_range(length(unique(rn$runNO)))
  rn <- rn %>%
    mutate(clr = ifelse(runNO == 0, "grey", colors[rn$runNO]))
  
  ggTraces <- ggplot() +
    geom_line(data = rn,
              aes(
                factor(track),
                maxdiff,
                group = runNO,
                color = clr,
                alpha = runNO,
                text = label
              )) +
    geom_point(data = rn[which(rn$pts > 0), ],
               aes(
                 factor(track),
                 maxdiff,
                 size = pts,
                 color = "tomato",
                 text = label
               )) +
    scale_y_time() +
    scale_size_continuous(range = c(.05, 2.75)) +
    scale_color_identity() +
    scale_alpha_continuous(range = c(.35, .8)) +
    labs(x = "",
         y = "") +
    theme_minimal() +
    theme(
      axis.text.x = element_text(
        angle = 45,
        hjust = 0.98,
        vjust = 0.9
      ),
      axis.text = element_text(size = 8),
      axis.ticks = element_line(size = .2),
      panel.grid = element_line(size = .2),
      panel.border = element_rect(fill = NA, size = .2),
      legend.position = "none"
    )
  
  ggplotly(ggTraces, tooltip = "text") %>%
    layout(margin = list(t = 60),
           title = list(
             text = paste0(
               'Improvement from Slowest Run',
               '<br><sup>',
               input$v_cat2,
               ', 150cc, No Items</sup>'
             )
           ))
})
```

### Run Time

```{r warning=FALSE}
renderPlotly({
  ggLine <- run_time %>%
    filter(cat2 == input$v_cat2) %>%
    mutate(label = paste0(
      "<b>Run #",
      runNO,
      " ",
      date,
      "</b>",
      "<br>",
      round(seconds_to_period(cumsum), 2)
    )) %>%
    ggplot(aes(runNO, cumsum)) +
    geom_line() +
    geom_point(aes(text = label)) +
    scale_y_time() +
    labs(x = "Run Number", y = "") +
    theme_minimal() +
    theme(axis.ticks = element_line(size = .2),
          panel.border = element_rect(fill = NA, size = .2))
  
  ggplotly(ggLine, tooltip = "text")
})
```