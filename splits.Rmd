---
title: "Mario Kart Speedruns"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    navbar:
      - { icon: "fas fa-home", href: "index.html", align: right}
---

```{bash include=FALSE}
# Convert all lss files in folder to csv
MK8D_trk2csv ./_data/splits ./_data/splits MK8D_trks.csv
```

```{r}
library(tidyverse)
library(lubridate)
```

```{r}
# Correct inconsistencies in track names between my splits & the MK8D python package (required to run the next method).
# Better option would've been to assign track NOs join/recode that way.
raw <- read_csv("_data/splits/MK8D_trks.csv")
abr <- read_csv("_data/track-abbr.csv")

t48 <- raw %>% 
  filter(Category == "48 Tracks") %>% 
  left_join(abr, by = c("Track" = "split")) %>% 
  select(ID, lss, Time:Category) %>% 
  mutate(lss = replace_na(lss,"Start"),
         Version = "Cartridge",
         Items = "No Items") %>% 
  rename("Track" = "lss")

write_csv(t48, "_data/splits/trks_48.csv")
```

```{bash eval=FALSE, include=FALSE}
# Adds center line (mean, median, max), offset for each run, and split time columns.
# Could be done easily in R to reduce number of files in folder.
MK8D_run2csv ./_data/splits/trks_48.csv ./_data/splits MK8D_runs_max.csv max
MK8D_run2csv ./_data/splits/trks_48.csv ./_data/splits MK8D_runs_mean.csv mean
```

# 48 Tracks

## Col 1 Tracks {data-width="350"}

### Violin Plot

```{r}
t0 <- t48 %>% 
  filter(Track != "Start") %>% 
  mutate(Time = seconds(Time),
         Track = fct_inorder(Track)) %>% 
  group_by(Track) %>% 
  mutate(sd = sd(Time)) %>% 
  ungroup()
```

```{r}
library(plotly)
```

```{r}
gg48 <- t0 %>% 
  ggplot(aes(factor(Track), Time)) +
  geom_violin(draw_quantiles = 0.5, 
              scale = "width",
              aes(fill = sd, color=sd),
              alpha = .7) +
  stat_summary(fun = "median", geom = "point", size = .4) +
  scale_y_time() +
  scale_x_discrete(limits = rev(levels(t0$Track))) +
  coord_flip() +
  labs(x = "",
       y = "Time") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 0.98,
                                   vjust = 0.9),
        axis.text = element_text(size = 8),
        axis.ticks = element_line(size = .2),
        panel.grid = element_line(size = .2),
        panel.border = element_rect(fill = NA, size = .2),
        legend.position = "none")

ggplotly(gg48)
```

## Col 2 Runs {.tabset}

```{r message=FALSE, warning=FALSE}
# Add column identifying stat, rename all files to have matching column names.
runMean <- read_csv("_data/splits/MK8D_runs_mean.csv") %>% 
  mutate(center = "mean", .before = `Center mean`) %>% 
  rename(c_time = `Center mean`,
         offset = `Center offset`)

runMax <- read_csv("_data/splits/MK8D_runs_max.csv") %>% 
  mutate(center = "max", .before = `Center amax`) %>% 
  rename(c_time = `Center amax`,
         offset = `Center offset`)

runMed <- read_csv("_data/splits/MK8D_runs_med.csv") %>% 
  mutate(center = "median", .before = `Center median`) %>% 
  rename(c_time = `Center median`,
         offset = `Center offset`)

# Combine files so defining col_types w/ lubridate will be quicker.
r0 <- rbind(runMean, runMax, runMed) %>%
  mutate(
    Time = seconds(Time),
    c_time = seconds(c_time),
    offset = seconds(offset),
    Track = fct_inorder(Track),
    date = str_extract_all(ID, "\\d{2}/\\d{2}/\\d{2}"),
    date = ymd(date),
    Track = recode(Track, "Start" = " ")
  ) %>% 
  group_by(ID) %>% 
  mutate(runNO = cur_group_id()) %>% 
  ungroup()
```

### Max

```{r}
ggMax <- r0 %>% 
  filter(center == "max") %>%
  ggplot(aes(
    factor(Track),
    offset,
    group = ID,
    color = runNO,
    alpha = runNO
  )) +
  geom_line() +
  scale_y_time() +
  scale_color_continuous(low = "plum", high = "darkcyan") +
  scale_alpha_continuous(range = c(.35, .8)) +
  labs(x = "",
       y = "Offset Time from Max") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.98,
      vjust = 0.9
    ),
    axis.text = element_text(size = 8),
    axis.ticks = element_line(size = .2),
    panel.grid = element_line(size = .2),
    panel.border = element_rect(fill = NA, size = .2),
    legend.position = "none"
  )

ggplotly(ggMax)
```

### Mean

```{r}
ggMean <- r0 %>% 
  filter(center == "mean") %>%
  ggplot(aes(
    factor(Track),
    offset,
    group = ID,
    color = runNO,
    alpha = runNO
  )) +
  geom_line() +
  scale_y_time() +
  scale_color_continuous(low = "plum", high = "darkcyan") +
  scale_alpha_continuous(range = c(.35, .8)) +
  labs(x = "",
       y = "Offset Time from Mean") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.98,
      vjust = 0.9
    ),
    axis.text = element_text(size = 8),
    axis.ticks = element_line(size = .2),
    panel.grid = element_line(size = .2),
    panel.border = element_rect(fill = NA, size = .2),
    legend.position = "none"
  )

ggplotly(ggMean)
```


# Nitro Cups {data-navmenu="Cups"}

```{r}
lvl <- paste(abr$cup, "Cup") %>% unique() %>% fct_inorder()

cups <- raw %>% 
  filter(str_detect(Category, "Cups")) %>% 
  mutate(Track = str_replace(Track, "^b", "w")) %>% 
  left_join(abr, by = c("Track" = "trk")) %>% 
  select(ID, trkNO, track, Time:Category) %>% 
  mutate(track = replace_na(track, "Start"),
         trkNO = replace_na(trkNO, 0),
         Version = "Cartridge",
         cup = Speed,
         Speed = "150cc",
         Items = "No Items",
         runID = str_extract(ID, "\\(.+\\)"),
         date = str_extract_all(ID, "\\d{2}/\\d{2}/\\d{2}"),
         date = ymd(date),
         cup = factor(cup, levels = lvl)) %>% 
  filter(!is.na(date)) %>% 
  group_by(runID) %>% 
  mutate(cumtime = cumsum(Time)) %>% 
  ungroup() %>% 
  arrange(trkNO) %>% 
  mutate(track = fct_inorder(track)) 
```

## Col 1 Tracks {data-width="350"}

```{r}
cnV <- cups %>% 
  filter(Category == "Nitro Cups" & track != "Start") %>% 
  group_by(track) %>% 
  mutate(Time = seconds(Time),
         sd = sd(Time)) %>% 
  ungroup()
```

### Violin Plot

```{r}
ggCNV <- cnV %>% 
  ggplot(aes(factor(track), Time)) +
  geom_violin(draw_quantiles = 0.5, 
              scale = "width",
              aes(fill = sd, color=sd),
              alpha = .7) +
  stat_summary(fun = "median", geom = "point", size = .4) +
  scale_y_time() +
  scale_x_discrete(limits = rev) +
  coord_flip() +
  labs(x = "",
       y = "Time") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 0.98,
                                   vjust = 0.9),
        axis.text = element_text(size = 8),
        axis.ticks = element_line(size = .2),
        panel.grid = element_line(size = .2),
        panel.border = element_rect(fill = NA, size = .2),
        legend.position = "none")

ggplotly(ggCNV)
```

## Col 2 Runs {.tabset}

```{r}
# Slice 10 most recent runs, add alpha value
c2 <- cups %>% 
  select(cup, ID) %>% 
  group_by(cup) %>% 
  distinct() %>% 
  mutate(runNO = dense_rank(ID)) %>%
  slice_max(runNO, n = 10) %>% 
  mutate(alph = dense_rank(runNO)) %>% 
  ungroup() %>% 
  left_join(cups, by = c("cup", "ID")) 

c3 <- cups %>% 
  select(cup, ID) %>% 
  group_by(cup) %>% 
  distinct() %>% 
  mutate(runNO = dense_rank(ID)) %>% 
  anti_join(c2, by = "ID") %>% 
  mutate(alph = 1) %>% 
  ungroup() %>% 
  left_join(cups, by = c("cup", "ID")) %>% 
  rbind(c2)

# Get max run
c4 <- c3 %>% 
  group_by(cup) %>% 
  slice_max(cumtime) %>% 
  ungroup() %>% 
  select(runID) %>% 
  left_join(c3, by = "runID") %>% 
  select(cup, track, cumtime) %>% 
  rename(max = cumtime) %>% 
  left_join(c3, by = c("cup", "track")) %>% 
  group_by(track) %>% 
  mutate(mean = mean(cumtime)) %>% 
  ungroup() %>% 
  pivot_longer(cols = c(max, mean), names_to = "stat", values_to = "ctime") %>% 
  mutate(
    offset = cumtime - ctime,
    cumtime = seconds(cumtime),
    Time = seconds(Time),
    ctime = seconds(ctime),
    offset = seconds(offset))
  
```

```{r}
cnT <- c4 %>%
  filter(Category == "Nitro Cups") %>% 
  mutate(track = recode(track, "Start" = " ")) 
```

### Max

```{r}
ggCNMax <- cnT %>% 
  filter(stat == "max") %>%
  ggplot(aes(
    factor(track),
    offset,
    group = ID,
    color = alph,
    alpha = alph
  )) +
  geom_line() +
  facet_wrap(~cup, scales = "free") +
  scale_x_discrete(labels = setNames(cnT$track, cnT$trkNO)) +
  scale_y_time() +
  scale_color_continuous(low = "plum", high = "darkcyan") +
  scale_alpha_continuous(range = c(.35, .8)) +
  labs(x = "",
       y = "") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.98,
      vjust = 0.9
    ),
    axis.text = element_text(size = 8),
    axis.ticks = element_line(size = .2),
    panel.grid = element_line(size = .2),
    panel.border = element_rect(fill = NA, size = .2),
    legend.position = "none"
  )

m <- list(b = 110)

ggplotly(ggCNMax) %>% 
  layout(margin = m)
```

### Mean

```{r}
ggCNMean <- cnT %>% 
  filter(stat == "mean") %>%
  ggplot(aes(
    factor(track),
    offset,
    group = ID,
    color = alph,
    alpha = alph
  )) +
  geom_line() +
  facet_wrap(~cup, scales = "free") +
  scale_x_discrete(labels = setNames(cnT$track, cnT$trkNO)) +
  scale_y_time() +
  scale_color_continuous(low = "plum", high = "darkcyan") +
  scale_alpha_continuous(range = c(.35, .8)) +
  labs(x = "",
       y = "") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.98,
      vjust = 0.9
    ),
    axis.text = element_text(size = 8),
    axis.ticks = element_line(size = .2),
    panel.grid = element_line(size = .2),
    panel.border = element_rect(fill = NA, size = .2),
    legend.position = "none"
  )

ggplotly(ggCNMean) %>% 
  layout(margin = m)
```

# Retro Cups {data-navmenu="Cups"}

## Col 1 Tracks {data-width="350"}

```{r}
crV <- cups %>% 
  filter(Category == "Retro Cups" & track != "Start") %>% 
  group_by(track) %>% 
  mutate(Time = seconds(Time),
         sd = sd(Time)) %>% 
  ungroup()
```

### Violin Plot

```{r}
ggCRV <- crV %>% 
  ggplot(aes(factor(track), Time)) +
  geom_violin(draw_quantiles = 0.5, 
              scale = "width",
              aes(fill = sd, color=sd),
              alpha = .7) +
  stat_summary(fun = "median", geom = "point", size = .4) +
  scale_y_time() +
  scale_x_discrete(limits = rev) +
  coord_flip() +
  labs(x = "",
       y = "Time") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 0.98,
                                   vjust = 0.9),
        axis.text = element_text(size = 8),
        axis.ticks = element_line(size = .2),
        panel.grid = element_line(size = .2),
        panel.border = element_rect(fill = NA, size = .2),
        legend.position = "none")

ggplotly(ggCRV) 
```

## Col 2 Runs {.tabset}

```{r}
crT <- c4 %>%
  filter(Category == "Retro Cups") %>% 
  mutate(track = recode(track, "Start" = " ")) 
```

### Max

```{r}
ggCRMax <- crT %>% 
  filter(stat == "max") %>%
  ggplot(aes(
    factor(track),
    offset,
    group = ID,
    color = alph,
    alpha = alph
  )) +
  geom_line() +
  facet_wrap(~cup, scales = "free") +
  scale_x_discrete(labels = setNames(crT$track, crT$trkNO)) +
  scale_y_time() +
  scale_color_continuous(low = "plum", high = "darkcyan") +
  scale_alpha_continuous(range = c(.35, .8)) +
  labs(x = "",
       y = "") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.98,
      vjust = 0.9
    ),
    axis.text = element_text(size = 8),
    axis.ticks = element_line(size = .2),
    panel.grid = element_line(size = .2),
    panel.border = element_rect(fill = NA, size = .2),
    legend.position = "none"
  )

ggplotly(ggCRMax) %>% 
  layout(margin = m)
```

### Mean

```{r}
ggCRMean <- crT %>% 
  filter(stat == "mean") %>%
  ggplot(aes(
    factor(track),
    offset,
    group = ID,
    color = alph,
    alpha = alph
  )) +
  geom_line() +
  facet_wrap(~cup, scales = "free") +
  scale_x_discrete(labels = setNames(crT$track, crT$trkNO)) +
  scale_y_time() +
  scale_color_continuous(low = "plum", high = "darkcyan") +
  scale_alpha_continuous(range = c(.35, .8)) +
  labs(x = "",
       y = "") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.98,
      vjust = 0.9
    ),
    axis.text = element_text(size = 8),
    axis.ticks = element_line(size = .2),
    panel.grid = element_line(size = .2),
    panel.border = element_rect(fill = NA, size = .2),
    legend.position = "none"
  )

ggplotly(ggCRMean) %>% 
  layout(margin = m)
```


# Bonus Cups {data-navmenu="Cups"}

## Col 1 Tracks {data-width="350"}

```{r}
cbV <- cups %>% 
  filter(Category == "Bonus Cups" & track != "Start") %>% 
  group_by(track) %>% 
  mutate(Time = seconds(Time),
         sd = sd(Time)) %>% 
  ungroup()
```

### Violin Plot

```{r}
ggCbV <- cbV %>% 
  ggplot(aes(factor(track), Time)) +
  geom_violin(draw_quantiles = 0.5, 
              scale = "width",
              aes(fill = sd, color=sd),
              alpha = .7) +
  stat_summary(fun = "median", geom = "point", size = .4) +
  scale_y_time() +
  scale_x_discrete(limits = rev) +
  coord_flip() +
  labs(x = "",
       y = "Time") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 0.98,
                                   vjust = 0.9),
        axis.text = element_text(size = 8),
        axis.ticks = element_line(size = .2),
        panel.grid = element_line(size = .2),
        panel.border = element_rect(fill = NA, size = .2),
        legend.position = "none")

ggplotly(ggCbV)
```

## Col 2 Runs {.tabset}

```{r}
cbT <- c4 %>%
  filter(Category == "Bonus Cups") %>% 
  mutate(track = recode(track, "Start" = " ")) 
```

### Max

```{r}
ggCbMax <- cbT %>% 
  filter(stat == "max") %>%
  ggplot(aes(
    factor(track),
    offset,
    group = ID,
    color = alph,
    alpha = alph
  )) +
  geom_line() +
  facet_wrap(~cup, scales = "free") +
  scale_x_discrete(labels = setNames(cbT$track, cbT$trkNO)) +
  scale_y_time() +
  scale_color_continuous(low = "plum", high = "darkcyan") +
  scale_alpha_continuous(range = c(.35, .8)) +
  labs(x = "",
       y = "") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.98,
      vjust = 0.9
    ),
    axis.text = element_text(size = 8),
    axis.ticks = element_line(size = .2),
    panel.grid = element_line(size = .2),
    panel.border = element_rect(fill = NA, size = .2),
    legend.position = "none"
  )

ggplotly(ggCbMax) %>% 
  layout(margin = m)
```

### Mean

```{r}
ggCbMean <- cbT %>% 
  filter(stat == "mean") %>%
  ggplot(aes(
    factor(track),
    offset,
    group = ID,
    color = alph,
    alpha = alph
  )) +
  geom_line() +
  facet_wrap(~cup, scales = "free") +
  scale_x_discrete(labels = setNames(cbT$track, cbT$trkNO)) +
  scale_y_time() +
  scale_color_continuous(low = "plum", high = "darkcyan") +
  scale_alpha_continuous(range = c(.35, .8)) +
  labs(x = "",
       y = "") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.98,
      vjust = 0.9
    ),
    axis.text = element_text(size = 8),
    axis.ticks = element_line(size = .2),
    panel.grid = element_line(size = .2),
    panel.border = element_rect(fill = NA, size = .2),
    legend.position = "none"
  )

ggplotly(ggCbMean) %>% 
  layout(margin = m)
```


# DLC Cups {data-navmenu="Cups"}

## Col 1 Tracks {data-width="350"}

```{r}
cdV <- cups %>% 
  filter(Category == "DLC Cups" & track != "Start") %>% 
  group_by(track) %>% 
  mutate(Time = seconds(Time),
         sd = sd(Time)) %>% 
  ungroup()
```

### Violin Plot

```{r}
ggCdV <- cdV %>% 
  ggplot(aes(factor(track), Time)) +
  geom_violin(draw_quantiles = 0.5, 
              scale = "width",
              aes(fill = sd, color=sd),
              alpha = .7) +
  stat_summary(fun = "median", geom = "point", size = .4) +
  scale_y_time() +
  scale_x_discrete(limits = rev) +
  coord_flip() +
  labs(x = "",
       y = "Time") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 0.98,
                                   vjust = 0.9),
        axis.text = element_text(size = 8),
        axis.ticks = element_line(size = .2),
        panel.grid = element_line(size = .2),
        panel.border = element_rect(fill = NA, size = .2),
        legend.position = "none")

ggplotly(ggCdV)
```

## Col 2 Runs {.tabset}

```{r}
cdT <- c4 %>%
  filter(Category == "DLC Cups") %>% 
  mutate(track = recode(track, "Start" = " ")) 
```

### Max

```{r}
ggCdMax <- cdT %>% 
  filter(stat == "max") %>%
  ggplot(aes(
    factor(track),
    offset,
    group = ID,
    color = alph,
    alpha = alph
  )) +
  geom_line() +
  facet_wrap(~cup, scales = "free") +
  scale_x_discrete(labels = setNames(cdT$track, cdT$trkNO)) +
  scale_y_time() +
  scale_color_continuous(low = "plum", high = "darkcyan") +
  scale_alpha_continuous(range = c(.35, .8)) +
  labs(x = "",
       y = "") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.98,
      vjust = 0.9
    ),
    axis.text = element_text(size = 8),
    axis.ticks = element_line(size = .2),
    panel.grid = element_line(size = .2),
    panel.border = element_rect(fill = NA, size = .2),
    legend.position = "none"
  )

ggplotly(ggCdMax) %>% 
  layout(margin = m)
```

### Mean

```{r}
ggCdMean <- cdT %>% 
  filter(stat == "mean") %>%
  ggplot(aes(
    factor(track),
    offset,
    group = ID,
    color = alph,
    alpha = alph
  )) +
  geom_line() +
  facet_wrap(~cup, scales = "free") +
  scale_x_discrete(labels = setNames(cdT$track, cdT$trkNO)) +
  scale_y_time() +
  scale_color_continuous(low = "plum", high = "darkcyan") +
  scale_alpha_continuous(range = c(.35, .8)) +
  labs(x = "",
       y = "") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(
      angle = 45,
      hjust = 0.98,
      vjust = 0.9
    ),
    axis.text = element_text(size = 8),
    axis.ticks = element_line(size = .2),
    panel.grid = element_line(size = .2),
    panel.border = element_rect(fill = NA, size = .2),
    legend.position = "none"
  )

ggplotly(ggCdMean) %>% 
  layout(margin = m)
```
