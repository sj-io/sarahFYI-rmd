---
title: "Mario Kart 150cc Time Trial PBs"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    theme: sandstone
    navbar:
      - { icon: "fas fa-home", href: "https://sarah.fyi/index", align: right}
---

```{r}
library(tidyverse)
library(plotly)
library(lubridate)
library(gt)
```

```{r}
abr <- read_csv("_data/track-abbr.csv") 

tt <- read_csv("_data/time-trials.csv", 
               col_types = cols(total = "c")) %>% 
  filter(cc == 150) %>% 
  mutate(total = ms(total),
         yr = year(date),
         mth = month(date),
         day = day(date),
         hour = hour(time),
         min = minute(time),
         dt = make_datetime(year = yr, month = mth, day = day, hour = hour, min = min)) %>% 
  left_join(abr) %>%
  mutate(track = fct_reorder(track, trkNO))

ttwr <- read_csv("_data/tt-wr.csv",
                 col_types = cols(total = "c")) %>% 
  mutate(total = ms(total))
```

# All Tracks

## Column 1

### Time Trial PB Distributions, Feb 01, 2022 - Present

```{r fig.height=10}
ggtt <- tt %>% 
  filter(trk != "dBP") %>% 
  group_by(track) %>% 
  mutate(sd = sd(total)) %>% 
  ungroup() %>% 
  ggplot(aes(factor(track), total)) +
  geom_violin(draw_quantiles = 0.5, 
              scale = "width",
              aes(fill = sd, color=sd),
              alpha = .7) + 
  stat_summary(fun = "median", geom = "point", size = .4) +
  scale_y_time() +
  scale_x_discrete(limits = rev(levels(tt$track))) +
  coord_flip() +
  labs(x = "",
       y = "PB Time") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 0.98,
                                   vjust = 0.9),
        axis.text = element_text(size = 8),
        axis.ticks = element_line(size = .2),
        panel.grid = element_line(size = .2),
        panel.border = element_rect(fill = NA, size = .2),
        legend.position = "none")

ggplotly(ggtt)
```

## Column 2

```{r}
ttDiff <- tt %>% 
  arrange(trk, dt) %>% 
  group_by(trk) %>% 
  mutate(prev = lag(total), .after = total,
         diff = as.double(prev - total, units = "secs"),
         diff = replace_na(diff, 0)
         ) %>% 
  mutate(cumsum = cumsum(diff), .after = diff) 

wk <- ttDiff %>% 
  filter(!is.na(prev)) %>% 
  ungroup() %>% 
  mutate(week = (week(date)-4)) %>% 
  group_by(week) %>% 
  summarise(mean = mean(diff), n = n())

wr <- ttDiff %>% 
  slice_max(dt) %>% 
  ungroup() %>% 
  arrange(trkNO) %>% 
  left_join(ttwr, by = "trk") %>% 
  select(date, track, total.x, cumsum, cup, type, player, total.y) %>% 
  mutate(diff = as.double(total.x - total.y, units = "secs"))
```


### Number of PBs by Week

```{r}
ggN <- ggplot() +
  geom_line(data = wk, aes(x=week, y=n)) +
  theme_minimal() +
  labs(y = "PBs",
       x = "Week")

ggN <- ggN + 
  annotate("text", x = 5, y = 67, alpha = .70, label = "Wave 1\nRelease",
           parse = TRUE)

ggplotly(ggN)
```

### Average Improvement by Week

```{r}
ggWk <- wk %>% 
  ggplot(aes(x=week, y=mean)) +
  geom_line() +
  theme_minimal() + 
  labs(x = "Week",
       y = "Average Time Save (secs)")

ggWk <- ggWk +
  annotate("text", x = 6.5, y = 1.12, alpha = .70,
           label = "Switch to Meta\nCharacter", parse = TRUE)

ggplotly(ggWk)
```

## Column 3

### Worst Tracks

```{r}
wr %>% 
  select(track, diff) %>% 
  arrange(desc(diff)) %>% 
  head(7) %>% 
  gt() %>% 
  cols_label(
    'track' = 'Track',
    'diff' = 'WR Diff.'
    )
```

### Best Tracks

```{r}
wr %>% 
  select(track, diff) %>% 
  arrange(diff) %>% 
  head(7) %>% 
  gt() %>% 
  cols_label(
    'track' = 'Track',
    'diff' = 'WR Diff.'
    )
```

### Most Improved since Feb. 2022

```{r}
wr %>% 
  filter(type != "wave1") %>% 
  select(track, cumsum) %>% 
  arrange(desc(cumsum)) %>% 
  head(7) %>% 
  gt() %>% 
  cols_label(
    'track' = 'Track',
    'cumsum' = 'Improvement'
    )
```


# Nitro Cups

## Column 1

### Current PBs vs. WR

```{r}
wr %>% 
  filter(type == "nitro") %>% 
  select(track, cumsum, date, total.x, total.y, diff, cup) %>% 
  group_by(cup) %>% 
  gt() %>% 
  cols_label(
    'track' = 'Track',
    'cumsum' = 'Cum. Time Save',
    'date' = 'Last PB',
    'total.x' = 'PB',
    'total.y' = 'WR',
    'diff' = 'WR Diff.'
    ) %>% 
  tab_style(
    style = cell_text(size = px(12)),
    locations = cells_body(
      columns = c(total.x, total.y, date)
    )
  ) %>% 
  fmt_date(
    columns = date,
    date_style = 6
  ) %>% 
  tab_options(
    row_group.as_column = TRUE
  ) 
```

## Column 2

### Mushroom Cup

```{r}
ggM <- ttDiff %>% 
  filter(cup == "Mushroom") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(ggM)
```

### Flower Cup

```{r}
gg2 <- ttDiff %>% 
  filter(cup == "Flower") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg2)
```

## Column 3

### Star Cup

```{r}
gg3 <- ttDiff %>% 
  filter(cup == "Star") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg3)
```

### Special Cup

```{r}
gg4 <- ttDiff %>% 
  filter(cup == "Special") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg4)
```

# Retro Cups

## Column 1

### Current PBs vs. WR

```{r}
wr %>% 
  filter(type == "retro") %>% 
  select(track, cumsum, date, total.x, total.y, diff, cup) %>% 
  group_by(cup) %>% 
  gt() %>% 
  cols_label(
    'track' = 'Track',
    'cumsum' = 'Cum. Time Save',
    'date' = 'Last PB',
    'total.x' = 'PB',
    'total.y' = 'WR',
    'diff' = 'WR Diff.'
    ) %>% 
  tab_style(
    style = cell_text(size = px(12)),
    locations = cells_body(
      columns = c(total.x, total.y, date)
    )
  ) %>% 
  fmt_date(
    columns = date,
    date_style = 6
  ) %>% 
  tab_options(
    row_group.as_column = TRUE
  ) 
```

## Column 2

### Shell Cup

```{r}
gg5 <- ttDiff %>% 
  filter(cup == "Shell") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg5)
```

### Banana Cup

```{r}
gg6 <- ttDiff %>% 
  filter(cup == "Banana") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg6)
```

## Column 3

### Leaf Cup

```{r}
gg7 <- ttDiff %>% 
  filter(cup == "Leaf") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg7)
```

### Lightning Cup

```{r}
gg8 <- ttDiff %>% 
  filter(cup == "Lightning") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg8)
```

# Bonus Cups

## Column 1

### Current PBs vs. WR

```{r}
wr %>% 
  filter(type == "DLC") %>% 
  select(track, cumsum, date, total.x, total.y, diff, cup) %>% 
  distinct() %>% 
  group_by(cup) %>% 
  gt() %>% 
  cols_label(
    'track' = 'Track',
    'cumsum' = 'Cum. Time Save',
    'date' = 'Last PB',
    'total.x' = 'PB',
    'total.y' = 'WR',
    'diff' = 'WR Diff.'
    ) %>% 
  tab_style(
    style = cell_text(size = px(12)),
    locations = cells_body(
      columns = c(total.x, total.y, date)
    )
  ) %>% 
  fmt_date(
    columns = date,
    date_style = 6
  ) %>% 
  tab_options(
    row_group.as_column = TRUE
  ) 
```

## Column 2

### Egg Cup

```{r}
gg9 <- ttDiff %>% 
  filter(cup == "Egg") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg9)
```

### Triforce Cup

```{r}
gg10 <- ttDiff %>% 
  filter(cup == "Triforce") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg10)
```

## Column 3

### Crossing Cup

```{r}
gg11 <- ttDiff %>% 
  filter(cup == "Crossing") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg11)
```

### Bell Cup

```{r}
gg12 <- ttDiff %>% 
  filter(cup == "Bell") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg12)
```

# DLC Cups

## Column 1

### Golden Dash Cup

```{r}
gg13 <- ttDiff %>% 
  filter(cup == "Golden Dash") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg13)
```

## Column 2

### Lucky Cat Cup

```{r}
gg14 <- ttDiff %>% 
  filter(cup == "Lucky Cat") %>% 
  ggplot(aes(x=dt, y=cumsum, color=track)) +
  geom_point() +
  geom_step() +
  theme_minimal() +
  labs(x="", y="") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none")

ggplotly(gg14)
```
